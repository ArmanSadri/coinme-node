{"version":3,"sources":["../../../src/js/cache/LocalFileCache.js"],"names":["LocalFileCache","options","path","take","adapter","value","tmpdir","config","_config","watchDirectoryChanges","watchFileChanges","hashAlgo","gzip","deflate","debug","defaults","_fc","_path","_started","fc","scope","on","d","logger","p","k","length","mime_type","mtime","toUTCString","_startedLatch","resolve","reject","cache_dir","toString","err","load","cache","_items","startedLatch","catch","_error","finally","base_path","then","error","joinPaths","absolutePath","pathString","substring","startsWith","filePath","items","result","warn"],"mappings":"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","file":"LocalFileCache.js","sourcesContent":["import Utility from \"../Utility\";\r\nimport URI from \"urijs\";\r\nimport filecache from \"filecache\";\r\nimport Promise from \"bluebird\";\r\nimport osenv from \"osenv\";\r\nimport mkdirp from \"mkdirp\";\r\nimport Cache from \"./Cache\";\r\n\r\n/**\r\n * @class LocalFileCache\r\n * @extends Cache\r\n */\r\nclass LocalFileCache extends Cache {\r\n\r\n    _config = {\r\n        watchDirectoryChanges: true,\r\n        watchFileChanges: false,\r\n        hashAlgo: 'sha1',\r\n        gzip: true,\r\n        deflate: true,\r\n        debug: true\r\n    };\r\n\r\n    //region constructor\r\n    /**\r\n     *\r\n     * @param {Object} options\r\n     * @param {String|URI} [options.path] defaults to tmpdir\r\n     * @param {{watchDirectoryChanges: boolean, watchFileChanges: boolean, hashAlgo: string, gzip: boolean, deflate: boolean, debug: boolean}} [options.config]\r\n     */\r\n    constructor(options) {\r\n        let path = Utility.take(options, 'path', {\r\n            adapter(value) {\r\n                return URI(value || (osenv.tmpdir() + '/coinme'));\r\n            }\r\n        });\r\n\r\n        let config = Utility.take(options, 'config', false);\r\n\r\n        super(options);\r\n\r\n        this._config = Utility.defaults(config || {}, this._config);\r\n        this._fc = filecache(this.config);\r\n        this._path = path;\r\n        this._started = false;\r\n\r\n        let fc = this.fc;\r\n        let scope = this;\r\n\r\n        if (this.config.watchDirectoryChanges && this.config.debug) {\r\n            fc.on('change', function (d) {\r\n                scope.logger.debug('! file changed');\r\n                scope.logger.debug('     full path: %s', d.p);\r\n                scope.logger.debug(' relative path: %s', d.k);\r\n                scope.logger.debug('        length: %s bytes', d.length);\r\n                scope.logger.debug('                %s bytes (gzip)', d.gzip.length);\r\n                scope.logger.debug('                %s bytes (deflate)', d.deflate.length);\r\n                scope.logger.debug('     mime-type: %s', d.mime_type);\r\n                scope.logger.debug('         mtime: %s', d.mtime.toUTCString());\r\n            });\r\n        }\r\n\r\n        this._startedLatch = new Promise((resolve, reject) => {\r\n            let cache_dir = scope.path.toString();\r\n\r\n            mkdirp(cache_dir, function (err) {\r\n                if (err) {\r\n                    return reject(err);\r\n                }\r\n\r\n                fc.load(cache_dir, function (err, cache) {\r\n                    if (err) {\r\n                        reject(err);\r\n                    } else {\r\n                        scope._items = cache;\r\n\r\n                        resolve();\r\n                    }\r\n                });\r\n\r\n                fc.on('ready', function (cache) {\r\n                    scope._items = cache;\r\n                });\r\n            })\r\n        });\r\n\r\n        this.startedLatch.catch((err) => {\r\n            scope._error = err;\r\n        });\r\n\r\n        this.startedLatch.finally(() => {\r\n            scope._started = true;\r\n        });\r\n    }\r\n\r\n    //endregion\r\n\r\n    //region getters/setters\r\n    /**\r\n     * @property\r\n     * @readonly\r\n     * @type {Promise}\r\n     * @return {Promise}\r\n     */\r\n    get startedLatch() {\r\n        return this._startedLatch;\r\n    }\r\n\r\n    /**\r\n     * @property\r\n     * @readonly\r\n     * @type {boolean}\r\n     * @return {boolean}\r\n     */\r\n    get started() {\r\n        return this._started;\r\n    }\r\n\r\n    /**\r\n     * @property\r\n     * @readonly\r\n     * @type {undefined|Error}\r\n     * @return {boolean}\r\n     */\r\n    get hasError() {\r\n        return !!this.error;\r\n    }\r\n\r\n    /**\r\n     * @property\r\n     * @readonly\r\n     * @type {undefined|Error}\r\n     * @return {undefined|Error}\r\n     */\r\n    get error() {\r\n        return this._error;\r\n    }\r\n\r\n    /**\r\n     * The items in the cache.\r\n     * @readonly\r\n     * @private\r\n     * @type {Object}\r\n     * @return {Object}\r\n     */\r\n    get items() {\r\n        return this._items;\r\n    }\r\n\r\n    /**\r\n     * @private\r\n     * @property\r\n     * @readonly\r\n     * @type {filecache}\r\n     * @return {filecache}\r\n     */\r\n    get fc() {\r\n        return this._fc;\r\n    }\r\n\r\n    /**\r\n     * @property\r\n     * @readonly\r\n     * @type {String}\r\n     * @return {{watchDirectoryChanges: boolean, watchFileChanges: boolean, hashAlgo: string, gzip: boolean, deflate: boolean, debug: boolean}}\r\n     */\r\n    get config() {\r\n        return this._config;\r\n    }\r\n\r\n    /**\r\n     * @property\r\n     * @readonly\r\n     * @type {URI}\r\n     * @return {URI}\r\n     */\r\n    get path() {\r\n        return this._path;\r\n    }\r\n\r\n    //endregion\r\n\r\n    /**\r\n     *\r\n     * @param {String|URI} path\r\n     * @return {Promise}\r\n     */\r\n    read(path) {\r\n        /** @type {URI} */\r\n        let base_path = this.path;\r\n        /** @type {winston.Logger} */\r\n        let logger = this.logger;\r\n\r\n        let scope = this;\r\n\r\n        return super\r\n            .read(path)\r\n            .then((/** @type {URI} */path) => {\r\n                if (scope.error) {\r\n                    // an error here means that this cache is fucked.\r\n                    throw scope.error;\r\n                }\r\n\r\n                return path;\r\n            })\r\n            .then((path) => {\r\n                return URI.joinPaths(base_path, path);\r\n            })\r\n            .then((/** @type {URI} */absolutePath) => {\r\n                let pathString = absolutePath.toString().substring(base_path.toString().length);\r\n\r\n                if (pathString.startsWith('/')) {\r\n                    pathString = pathString.substring(1);\r\n                }\r\n\r\n                return pathString;\r\n            })\r\n            .then((/** @type {String} */filePath) => {\r\n                let items = scope.items;\r\n                let result = items[filePath];\r\n\r\n                if (!result) {\r\n                    logger.warn(`Not sure why, but ${filePath} was not found in ${items}`);\r\n                }\r\n\r\n                return result;\r\n            });\r\n    }\r\n}\r\n\r\nexport {LocalFileCache}\r\nexport default LocalFileCache;"]}