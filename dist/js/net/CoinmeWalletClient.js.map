{"version":3,"sources":["../../../src/js/net/CoinmeWalletClient.js"],"names":["VERSION_REGEXP","METHOD_REGEXP","customPromiseFactory","resolver","CoinmeWalletClientConfiguration","options","certificate","take","type","adapter","value","fromHome","isString","fromFolder","timeout","defaultValue","baseUrl","required","validator","uri","shouldBeInstanceOf","typeOf","shouldBeTrue","is","version","shouldBeString","shouldMatchRegexp","sessionId","identity","isInstance","shouldBeInstance","JSON","stringify","signTool","secret","toString","issuer","arguments","_identity","_sessionId","_baseUrl","_version","_signTool","_certificate","_startedLatch","resolve","reject","promise","then","startedLatch","optJson","toJson","optString","clone","overrides","assign","_timeout","CoinmeWalletClient","configuration","_configuration","withSessionId","receipt","json","_execute","method","data","username","shouldNotBeBlank","scope","_getUrl","transactionId","v1","timestamp","Date","getTime","signature","_sign","path","request_args","url","httpSignature","keyId","key","name","promiseFactory","fullResponse","headers","qs","err","res","body","result","call","relativeUri","parameters","write","audience","subject","stringOrUri","joinPaths","absoluteTo"],"mappings":"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","file":"CoinmeWalletClient.js","sourcesContent":["\"use strict\";\r\n\r\nimport CoreObject from \"../CoreObject\";\r\nimport Promise from \"bluebird\";\r\nimport request from \"request-promise\";\r\nimport Receipt from \"../data/Receipt\";\r\nimport Utility from \"../Utility\";\r\nimport Preconditions from \"../Preconditions\";\r\nimport URI from \"urijs\";\r\nimport request_debug from \"request-debug\";\r\nimport SignTool from \"../data/SignTool\";\r\nimport uuid from \"node-uuid\";\r\nimport Identity from \"../data/Identity\";\r\nimport Address from \"../Address\";\r\nimport Lodash from \"lodash\";\r\nimport UserExistenceToken from \"../data/UserExistenceToken\";\r\nimport CertificateBundle from \"../data/CertificateBundle\";\r\n\r\nrequest_debug(request);\r\n\r\nconst VERSION_REGEXP = /^\\/api\\/v(?:\\d+\\.?\\d*)+$/;\r\nconst METHOD_REGEXP = /(?:POST)|(?:GET)|(?:DELETE)|(?:PUT)/;\r\n\r\n\r\n/**\r\n * @param  {Function} resolver The promise resolver function\r\n * @return {Object} The promise instance\r\n */\r\nfunction customPromiseFactory(resolver) {\r\n    return new Promise(resolver);\r\n}\r\n\r\n//region class CoinmeWalletClientConfiguration\r\n/**\r\n * Certificates are required!\r\n *\r\n * The default value for certificates are found in CertificateBundle.fromHome()\r\n */\r\nclass CoinmeWalletClientConfiguration extends CoreObject {\r\n\r\n    //region constructor\r\n    /**\r\n     *\r\n     * @param {CoinmeWalletClientConfiguration|Object} [options]\r\n     * @param {CertificateBundle} [options.certificate]\r\n     * @param {String|URI} [options.baseUrl] defaults to https://www.coinmewallet.com\r\n     * @param {String} [options.version] defaults to /api/v1\r\n     * @param {SignTool} [options.signTool] defaults to null\r\n     * @param {String|Address|Identity} [options.identity] defaults to null\r\n     */\r\n    constructor(options) {\r\n        //region let certificate\r\n        /** @type {CertificateBundle} */\r\n        let certificate = Utility.take(options, 'certificate', {\r\n            type: CertificateBundle,\r\n            adapter: function (value) {\r\n                if (!value) {\r\n                    return CertificateBundle.fromHome();\r\n                } else if (Utility.isString(value)) {\r\n                    return CertificateBundle.fromFolder(value);\r\n                }\r\n\r\n                return value;\r\n            }\r\n        });\r\n        //endregion\r\n\r\n        //region let timeout\r\n        let timeout = Utility.take(options, 'timeout', {\r\n            type: 'number',\r\n            defaultValue: 30000\r\n        });\r\n        //endregion\r\n\r\n        //region let baseUrl\r\n        /** @type {URI} */\r\n        let baseUrl = Utility.take(options, 'baseUrl', {\r\n            required: false,\r\n            defaultValue: URI('https://www.coinmewallet.com/'),\r\n            // adapter goes first.\r\n            adapter: function (value) {\r\n                if (Utility.isString(value)) {\r\n                    return URI(value);\r\n                }\r\n\r\n                return value;\r\n            },\r\n            validator: function (uri) {\r\n                Preconditions.shouldBeInstanceOf(uri, URI, `value must be string or URI. (value:${uri}) (type:${Utility.typeOf(uri)})`);\r\n                Preconditions.shouldBeTrue(uri.is('absolute'), 'uri must be absolute');\r\n\r\n                return true;\r\n            }\r\n        });\r\n        //endregion\r\n\r\n        //region let version\r\n        let version = Utility.take(options, 'version', {\r\n            type: 'string',\r\n            defaultValue: '/api/v1',\r\n            required: false,\r\n            validator: function (value) {\r\n                Preconditions.shouldBeString(value, 'version must be a string');\r\n                Preconditions.shouldMatchRegexp(value, VERSION_REGEXP, `version must match pattern: ${VERSION_REGEXP}. Was ${value}`);\r\n\r\n                return true;\r\n            }\r\n        });\r\n        //endregion\r\n\r\n        //region let sessionId\r\n        let sessionId = Utility.take(options, 'sessionId', 'string', false);\r\n        //endregion\r\n\r\n        //region let identity\r\n        let identity = Utility.take(options, 'identity', {\r\n            defaultValue: new Identity('library:/coinme-node'),\r\n            adapter(value) {\r\n                if (Utility.isString(value)) {\r\n                    return new Identity(value);\r\n                } else if (Address.isInstance(value)) {\r\n                    return new Identity(value);\r\n                } else {\r\n                    return value;\r\n                }\r\n            },\r\n            validator(value) {\r\n                Preconditions.shouldBeInstance(value, Identity, `identity ${JSON.stringify(value)}`);\r\n            }\r\n        });\r\n        //endregion\r\n\r\n        //region let signTool\r\n        let signTool = Utility.take(options, 'signTool', {\r\n            type: SignTool,\r\n            defaultValue: new SignTool({\r\n                secret: identity.toString(),\r\n                issuer: identity.toString()\r\n            })\r\n        });\r\n        //endregion\r\n\r\n        super(...arguments);\r\n\r\n        this._identity = identity;\r\n        this._sessionId = sessionId;\r\n        this._baseUrl = baseUrl;\r\n        this._version = version;\r\n        this._signTool = signTool;\r\n        this._certificate = certificate;\r\n\r\n        this._startedLatch = new Promise((resolve, reject) => {\r\n            let promise = Promise.resolve();\r\n\r\n            promise = promise.then(() => certificate.startedLatch);\r\n\r\n            resolve(promise);\r\n        });\r\n    }\r\n\r\n    //endregion\r\n\r\n    //region properties\r\n    /**\r\n     * @return {Promise}\r\n     */\r\n    get startedLatch() {\r\n        return this._startedLatch;\r\n    }\r\n\r\n    /**\r\n     * @readonly\r\n     * @property\r\n     * @type {CertificateBundle}\r\n     * @return {CertificateBundle}\r\n     */\r\n    get certificate() {\r\n        return this._certificate;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @readonly\r\n     * @property\r\n     * @type {Identity}\r\n     * @return {Identity}\r\n     */\r\n    get identity() {\r\n        return this._identity;\r\n    }\r\n\r\n\r\n    /**\r\n     * @readonly\r\n     * @property\r\n     * @type {String|undefined}\r\n     * @return {String|undefined}\r\n     */\r\n    get sessionId() {\r\n        return this._sessionId;\r\n    }\r\n\r\n    /**\r\n     * Example: /api/v1\r\n     *\r\n     * @property\r\n     * @readonly\r\n     * @type {String}\r\n     * @return {String}\r\n     */\r\n    get version() {\r\n        return this._version;\r\n    }\r\n\r\n    /**\r\n     * @property\r\n     * @readonly\r\n     * @type {Number}\r\n     * @return {Number}\r\n     */\r\n    get timeout() {\r\n        return this._timeout;\r\n    }\r\n\r\n    /**\r\n     * Example: https://www.coinmewallet.com/\r\n     *\r\n     * @readonly\r\n     * @property\r\n     * @type {URI}\r\n     * @return {URI}\r\n     */\r\n    get baseUrl() {\r\n        return this._baseUrl\r\n    }\r\n\r\n    /**\r\n     * @property\r\n     * @readonly\r\n     * @type {SignTool}\r\n     * @return {SignTool}\r\n     */\r\n    get signTool() {\r\n        return this._signTool;\r\n    }\r\n\r\n    //endregion\r\n\r\n    toJson() {\r\n        return super.toJson({\r\n            identity: Utility.optJson(this.identity.toJson()),\r\n            signTool: Utility.optJson(this.signTool),\r\n            sessionId: this.sessionId,\r\n            version: this.version,\r\n            baseUrl: Utility.optString(this.baseUrl)\r\n        });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {String} sessionId\r\n     * @return {CoinmeWalletClientConfiguration}\r\n     */\r\n    withSessionId(sessionId) {\r\n        Preconditions.shouldBeString(sessionId, 'sessionId');\r\n\r\n        return new CoinmeWalletClientConfiguration(this.clone({\r\n            sessionId: sessionId\r\n        }));\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {Object} overrides\r\n     * @return {CoinmeWalletClientConfiguration}\r\n     */\r\n    clone(overrides) {\r\n        return new CoinmeWalletClientConfiguration(Lodash.assign({}, this, overrides));\r\n    }\r\n}\r\n//endregion\r\n\r\n//region class CoinmeWalletClient\r\n/**\r\n *\r\n */\r\nclass CoinmeWalletClient extends CoreObject {\r\n\r\n    //region constructor\r\n    /**\r\n     *\r\n     * @param {Object} options\r\n     * @param {CoinmeWalletClientConfiguration} options.configuration\r\n     */\r\n    constructor(options) {\r\n        /** @type {CoinmeWalletClientConfiguration} */\r\n        let configuration = Utility.take(options, 'configuration', CoinmeWalletClientConfiguration, true);\r\n\r\n        super(...arguments);\r\n\r\n        this._configuration = configuration;\r\n\r\n        this._startedLatch = new Promise((resolve, reject) => {\r\n            let promise = Promise.resolve();\r\n\r\n            promise = promise.then(() => configuration.startedLatch);\r\n\r\n            resolve(promise);\r\n        });\r\n    }\r\n\r\n    //endregion\r\n\r\n    //region properties\r\n    /**\r\n     * @property\r\n     * @readonly\r\n     * @type {Promise}\r\n     * @return {Promise}\r\n     */\r\n    get startedLatch() {\r\n        return this._startedLatch;\r\n    }\r\n\r\n    /**\r\n     * @property\r\n     * @readonly\r\n     * @return {CoinmeWalletClientConfiguration}\r\n     */\r\n    get configuration() {\r\n        return this._configuration;\r\n    }\r\n\r\n    //endregion\r\n\r\n    /**\r\n     * Creates a brand new copy/clone of this client with a sessionId attached.\r\n     *\r\n     * @param {String} sessionId\r\n     * @return {CoinmeWalletClient}\r\n     */\r\n    withSession(sessionId) {\r\n        return new CoinmeWalletClient({\r\n            configuration: this.configuration.withSessionId(sessionId)\r\n        });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {Receipt} receipt\r\n     * @return {Promise}\r\n     */\r\n    notifyReceipt(receipt) {\r\n        let json = receipt.toJson();\r\n\r\n        return this._execute({\r\n            uri: '/receipt',\r\n            method: 'POST',\r\n            data: json\r\n        });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {String} username\r\n     * @return {Promise<UserExistenceToken>|Promise}\r\n     */\r\n    peek(username) {\r\n        Preconditions.shouldNotBeBlank(username, 'username');\r\n\r\n        return this._execute({\r\n            uri: '/user/peek',\r\n            method: 'GET',\r\n            data: {\r\n                username: username\r\n            },\r\n\r\n            type: UserExistenceToken\r\n        });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @private\r\n     *\r\n     * @param {Object} options\r\n     * @param {String|URI} options.uri\r\n     * @param {String} options.method\r\n     * @param {Object} [options.data]\r\n     * @param {Function} [options.adapter]\r\n     * @param {Class} [options.type]\r\n     *\r\n     * @return {Promise}\r\n     */\r\n    _execute(options) {\r\n        var scope = this;\r\n\r\n        return Promise.resolve()\r\n            .then(() => this.startedLatch)\r\n            .then(function () {\r\n                let configuration = scope.configuration;\r\n\r\n                /**\r\n                 * @type {String}\r\n                 */\r\n                let method = Preconditions.shouldMatchRegexp(options.method, METHOD_REGEXP, 'Must be GET|POST|PUT|DELETE');\r\n\r\n                /**\r\n                 * @type {URI}\r\n                 */\r\n                let uri = scope._getUrl(options.uri);\r\n\r\n                /**\r\n                 * @type {Object}\r\n                 */\r\n                let data = options.data || {};\r\n\r\n                data.transactionId = uuid.v1();\r\n                data.timestamp = (new Date()).getTime();\r\n                data.signature = scope._sign(uri.path(), data);\r\n\r\n                let request_args = {\r\n                    url: uri.toString(),\r\n                    method: method,\r\n                    json: true,\r\n\r\n                    httpSignature: {\r\n                        keyId: configuration.certificate.key.name,\r\n                        key: configuration.certificate.key.value\r\n                    },\r\n                    timeout: scope.configuration.timeout,\r\n                    promiseFactory: customPromiseFactory,\r\n                    fullResponse: true, // (default) To resolve the promise with the full response or just the body\r\n                    headers: {\r\n                        'X-Transaction-ID': data.transactionId,\r\n                        'X-Timestamp': data.timestamp,\r\n                        'X-Signature': data.signature\r\n                    }\r\n                };\r\n\r\n                if ('GET' === method && data) {\r\n                    request_args.qs = data;\r\n                } else if ('POST' === method) {\r\n                    request_args.data = data;\r\n                }\r\n\r\n                return request(request_args, function (err, res, body) {\r\n                    // console.log('REQUEST RESULTS:', err, res.statusCode, body);\r\n                })\r\n                    .then((result) => {\r\n                        if (options.adapter) {\r\n                            return options.adapter.call(scope, result);\r\n                        } else if (options.type) {\r\n                            return new options.type(result)\r\n                        } else {\r\n                            return result;\r\n                        }\r\n                    });\r\n            });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @private\r\n     * @return {undefined|String}\r\n     */\r\n    _sign(relativeUri, parameters) {\r\n        return this.configuration.signTool.write(parameters || {}, {\r\n            issuer: this.configuration.identity.toString(),\r\n            audience: 'coinme-wallet',\r\n            subject: relativeUri.toString()\r\n        });\r\n    }\r\n\r\n    /**\r\n     * @param {String|URI} stringOrUri\r\n     * @return {URI}\r\n     * @private\r\n     */\r\n    _getUrl(stringOrUri) {\r\n        /** @type {URI} */\r\n        let uri = URI(stringOrUri);\r\n        /** @type {CoinmeWalletClientConfiguration} */\r\n        let configuration = this.configuration;\r\n        let baseUrl = configuration.baseUrl;\r\n        let version = configuration.version;\r\n\r\n        Preconditions.shouldBeTrue(uri.is('relative'), `Must be relative. Was ${stringOrUri}`);\r\n\r\n        return URI.joinPaths(baseUrl, version, uri).absoluteTo(baseUrl);\r\n    }\r\n\r\n}\r\n//endregion\r\n\r\nexport {CoinmeWalletClientConfiguration};\r\nexport {CoinmeWalletClient};\r\nexport default CoinmeWalletClient;"]}