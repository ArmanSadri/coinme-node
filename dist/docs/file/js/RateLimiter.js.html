<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">js/RateLimiter.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/coinme/coinme-node.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/Address.js~Address.html">Address</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/Coinme.js~Coinme.html">Coinme</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/CoreObject.js~CoreObject.html">CoreObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/Environment.js~Environment.html">Environment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/Functions.js~Functions.html">Functions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/Preconditions.js~Preconditions.html">Preconditions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/RateLimiter.js~RateLimiter.html">RateLimiter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/RateLimiter.js~SmoothBurstyRateLimiter.html">SmoothBurstyRateLimiter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/RateLimiter.js~SmoothRateLimiter.html">SmoothRateLimiter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/RateLimiter.js~SmoothWarmingUpRateLimiter.html">SmoothWarmingUpRateLimiter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/Stopwatch.js~Stopwatch.html">Stopwatch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/Ticker.js~Ticker.html">Ticker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/TimeUnit.js~TimeUnit.html">TimeUnit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/Utility.js~Utility.html">Utility</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">cache</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/cache/Cache.js~Cache.html">Cache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/cache/LocalFileCache.js~LocalFileCache.html">LocalFileCache</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/Adapter.js~Adapter.html">Adapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/CachedResourceLoader.js~CachedResourceLoader.html">CachedResourceLoader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/CertificateBundle.js~Certificate.html">Certificate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/CertificateBundle.js~CertificateBundle.html">CertificateBundle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/Conversion.js~Conversion.html">Conversion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/Converter.js~Converter.html">Converter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/DelegatedConverter.js~CoreObjectAdapter.html">CoreObjectAdapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/DelegatedConverter.js~DelegatedConverter.html">DelegatedConverter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/FileResourceLoader.js~FileResourceLoader.html">FileResourceLoader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/Identity.js~Identity.html">Identity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/Receipt.js~EndpointType.html">EndpointType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/Receipt.js~EndpointTypes.html">EndpointTypes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/Receipt.js~KioskEndpointType.html">KioskEndpointType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/Receipt.js~Receipt.html">Receipt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/Receipt.js~ReceiptBuilder.html">ReceiptBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/Receipt.js~ReceiptEndpoint.html">ReceiptEndpoint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/Receipt.js~WalletEndpointType.html">WalletEndpointType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/ResourceLoader.js~ResourceLoader.html">ResourceLoader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/SignTool.js~SignTool.html">SignTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/User.js~User.html">User</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/UserBuilder.js~UserBuilder.html">UserBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/data/UserExistenceToken.js~UserExistenceToken.html">UserExistenceToken</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">errors</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/errors/AbstractError.js~AbstractError.html">AbstractError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/errors/Errors.js~Errors.html">Errors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/errors/HttpError.js~HttpError.html">HttpError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/errors/NotImplementedError.js~NotImplementedError.html">NotImplementedError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/errors/PreconditionsError.js~PreconditionsError.html">PreconditionsError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ExtendableBuiltin">ExtendableBuiltin</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">money</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/money/Bitcoin.js~Bitcoin.html">Bitcoin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/money/Currency.js~Currency.html">Currency</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/money/CurrencyAdapter.js~CurrencyAdapter.html">CurrencyAdapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/money/Ethereum.js~Ethereum.html">Ethereum</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/money/Money.js~Money.html">Money</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/money/MoneyConverter.js~MoneyConverter.html">MoneyConverter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/money/Satoshi.js~Satoshi.html">Satoshi</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/money/USD.js~USD.html">USD</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">net</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/net/CoinmeWalletClient.js~CoinmeWalletClient.html">CoinmeWalletClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/net/CoinmeWalletClient.js~CoinmeWalletClientConfiguration.html">CoinmeWalletClientConfiguration</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">slack</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/slack/AbstractBuilder.js~AbstractBuilder.html">AbstractBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/slack/AbstractNotificationTemplate.js~AbstractNotificationTemplate.html">AbstractNotificationTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/slack/AttachmentBuilder.js~AttachmentBuilder.html">AttachmentBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/slack/FieldBuilder.js~FieldBuilder.html">FieldBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/slack/InlineNotificationTemplate.js~InlineNotificationTemplate.html">InlineNotificationTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/slack/NotificationBuilder.js~NotificationBuilder.html">NotificationBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/slack/NotificationService.js~NotificationService.html">NotificationService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/slack/NotificationTemplate.js~NotificationTemplate.html">NotificationTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/slack/UserNotificationTemplate.js~UserNotificationTemplate.html">UserNotificationTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-notificationService">notificationService</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/RateLimiter.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import Preconditions from &quot;./Preconditions&quot;;
import TimeUnit from &quot;./TimeUnit&quot;;
import Utility from &quot;./Utility&quot;;
import CoreObject from &quot;./CoreObject&quot;;
import Stopwatch from &quot;./Stopwatch&quot;;
import Errors from &quot;./errors/Errors&quot;;
import Logger from &apos;winston&apos;;

class RateLimiter extends CoreObject {

    _permitsPerSecond;

    constructor(options) {
        super(options);

        /**
         * @type {Stopwatch}
         * @private
         */
        this._stopwatch = new Stopwatch({ start: true });

        // /**
        //  * @type {String}
        //  * @private
        //  */
        // this._failAction = Utility.take(options, &apos;failAction&apos;, {
        //         type: &apos;string&apos;,
        //         required: false,
        //         defaultValue: &apos;wait&apos;
        //     });
    }

    //region property: {Stopwatch} stopwatch
    /**
     * @returns {Stopwatch}
     */
    get stopwatch() {
        return this._stopwatch;
    }

    //endregion

    //region property: {Ticker} ticker
    /**
     *
     * @return {Ticker}
     */
    get ticker() {
        return this.stopwatch.ticker;
    }
    //endregion

    //region property: {Number} permitsPerSecond

    /**
     * Updates the stable rate of this {@code RateLimiter}, that is, the
     * {@code permitsPerSecond} argument provided in the factory method that
     * constructed the {@code RateLimiter}. Currently throttled threads will &lt;b&gt;not&lt;/b&gt;
     * be awakened as a result of this invocation, thus they do not observe the new rate;
     * only subsequent requests will.
     *
     * &lt;p&gt;Note though that, since each request repays (by waiting, if necessary) the cost
     * of the &lt;i&gt;previous&lt;/i&gt; request, this means that the very next request
     * after an invocation to {@code setRate} will not be affected by the new rate;
     * it will pay the cost of the previous request, which is in terms of the previous rate.
     *
     * &lt;p&gt;The behavior of the {@code RateLimiter} is not modified in any other way,
     * e.g. if the {@code RateLimiter} was configured with a warmup period of 20 seconds,
     * it still has a warmup period of 20 seconds after this method invocation.
     *
     * @param {Number} permitsPerSecond the new stable rate of this {@code RateLimiter}
     * @throws IllegalArgumentException if {@code permitsPerSecond} is negative or zero
     */
    set permitsPerSecond(permitsPerSecond) {
        Preconditions.shouldBeExisting(permitsPerSecond);
        Preconditions.shouldBeTrue(permitsPerSecond &gt; 0.0 &amp;&amp; !Utility.isNaN(permitsPerSecond), &quot;rate must be positive&quot;);

        this._permitsPerSecond = Preconditions.shouldBePositiveNumber(permitsPerSecond, &apos;Rate must be positive&apos;);

        this.doSetRate(permitsPerSecond, this.stopwatch.elapsedMicros());
    }

    /**
     *
     * @returns {Number}
     */
    get permitsPerSecond() {
        return this._permitsPerSecond;
    }

    //endregion

    /**
     * Acquires a single permit from this {@code RateLimiter}. Returns a Promise that will resolve or reject.
     * The default maximum time to wait is 30 seconds.
     *
     * &lt;p&gt;This method is equivalent to {@code acquire(1)}.
     *
     * @param {Number} [permits] defaults to 1
     * @param {Number} [timeout] defaults to 30
     * @param {TimeUnit} [timeUnit] defaults to seconds
     * @return {Promise} time spent sleeping to enforce rate, in seconds; 0.0 if not rate-limited
     * @since 16.0 (present in 13.0 with {@code void} return type})
     */
    acquire(permits, timeout, timeUnit) {
        return this.tryAcquire(permits, timeout, timeUnit);
    }

    /**
     * Reserves the given number of permits from this {@code RateLimiter} for future use, returning
     * the number of microseconds until the reservation can be consumed.
     *
     * @param {Number} [permits]
     * @return {Number} time in microseconds to wait until the resource can be acquired, never negative
     */
    reserve(permits) {
        permits = this.checkPermits(permits);

        return this.reserveAndGetWaitLength(permits, this.stopwatch.elapsedMicros());
    }

    /**
     * Reserves next ticket and returns the wait time that the caller must wait for.
     *
     * @private
     * @param {Number} permits
     * @param {Number} nowMicros
     * @return {Number} the required wait time, never negative
     */
    reserveAndGetWaitLength(permits, nowMicros) {
        let momentAvailable = this.reserveEarliestAvailable(permits, nowMicros);
        let waitLength = Math.max(momentAvailable - nowMicros, 0);


        return waitLength;
    }

    /**
     * @private
     * @param {Number} nowMicros
     * @param {Number} timeoutMicros
     * @returns {boolean}
     */
    canAcquire(nowMicros, timeoutMicros) {
        return this.queryEarliestAvailable(nowMicros) - timeoutMicros &lt;= nowMicros;
    }

    /**
     * Acquires the given number of permits from this {@code RateLimiter} if it can be obtained
     * without exceeding the specified {@code timeout}, or returns {@code false}
     * immediately (without waiting) if the permits would not have been granted
     * before the timeout expired.
     *
     * @param {Number} [permits] the number of permits to acquire
     * @param {Number} [timeout] the maximum time to wait for the permits. Negative values are treated as zero.
     * @param {TimeUnit} [unit] the time unit of the timeout argument
     * @return {Promise} if the permits were acquired
     * @throws IllegalArgumentException if the requested number of permits is negative or zero
     */
    tryAcquire(permits, timeout, unit) {
        Preconditions.shouldBeNumber(this.permitsPerSecond, &apos;Rate must be defined.&apos;);

        permits = RateLimiter.checkPermits(permits);
        timeout = Utility.defaultNumber(timeout, 30);
        unit = Utility.defaultObject(unit, TimeUnit.SECONDS);

        let timeoutMicros = Math.max(unit.toMicros(timeout), 0);

        let microsToWait;
        let nowMicros = this.stopwatch.elapsedMicros();
        let goalMicros = this.queryEarliestAvailable(nowMicros);

        if (!this.canAcquire(nowMicros, timeoutMicros)) {
            return Promise.reject(new Error(`RateLimit exceeded: (rate:${this.permitsPerSecond}/sec) (timeoutMicros:${timeoutMicros}) (goalMicros: ${goalMicros}) (differenceMicros:${goalMicros - nowMicros})`));
        } else {
            microsToWait = this.reserveAndGetWaitLength(permits, nowMicros);
        }

        Preconditions.shouldBeExisting(this.ticker, &apos;ticker&apos;);
        return this.ticker.wait(microsToWait, TimeUnit.MICROSECONDS);
    }

    //region abstract
    /**
     * Returns the earliest time that permits are available (with one caveat).
     *
     * @param {Number} nowMicros
     * @return the time that permits are available, or, if permits are available immediately, an
     *     arbitrary past or present time
     */
    queryEarliestAvailable(nowMicros) {
        Errors.throwNotImplemented();
    }

    /**
     * Reserves the requested number of permits and returns the time that those permits can be used
     * (with one caveat).
     *
     * @param {Number} permits
     * @param {Number} nowMicros
     * @return {Number} the time that the permits may be used, or, if the permits may be used immediately, an
     *     arbitrary past or present time
     */
    reserveEarliestAvailable(permits, nowMicros) {
        Errors.throwNotImplemented();
    }

    //endregion

    //region statics
    /**
     * @private
     * @param {Number} [permits]
     * @returns {Number}
     */
    static checkPermits(permits) {
        if (Utility.isNotExisting(permits)) {
            return 1;
        }

        Preconditions.shouldBeNumber(permits, `Requested permits (${permits}) must be positive`);
        Preconditions.shouldBeTrue(permits &gt; 0, `Requested permits (${permits}) must be positive`);

        return permits;
    }

    //endregion
}

class SmoothRateLimiter extends RateLimiter {

    constructor(options) {
        super(options);

        /**
         * The currently stored permits.
         */
        this._storedPermits = 0;

        /**
         * The maximum number of stored permits.
         * @type {Number}
         * @private
         */
        this._maxPermits = 0;

        /**
         * The interval between two unit requests, at our stable rate. E.g., a stable rate of 5 permits
         * per second has a stable interval of 200ms.
         */
        this._stableIntervalMicros = 0;

        /**
         * The time when the next request (no matter its size) will be granted. After granting a
         * request, this is pushed further in the future. Large requests push this further than small
         * requests.
         * @type {Number}
         * @private
         */
        this._nextFreeTicketMicros = 0; // could be either in the past or future
    }

    /**
     * @protected
     * @param permitsPerSecond
     * @param nowMicros
     */
    doSetRate(permitsPerSecond, nowMicros) {
        this.resync(nowMicros);
        let stableIntervalMicros = TimeUnit.SECONDS.toMicros(1) / permitsPerSecond;
        this._stableIntervalMicros = stableIntervalMicros;
        this.doSetRate2(permitsPerSecond, stableIntervalMicros);
    }

    /**
     * @protected
     * @param permitsPerSecond
     * @param stableIntervalMicros
     */
    doSetRate2(permitsPerSecond, stableIntervalMicros) {
        Errors.throwNotImplemented();
    }

    queryEarliestAvailable(nowMicros) {
        return Preconditions.shouldBeNumber(this._nextFreeTicketMicros);
    }

    reserveEarliestAvailable(requiredPermits, nowMicros) {
        this.resync(nowMicros);
        let nextFreeTicketMicros = this._nextFreeTicketMicros;

        let returnValue = nextFreeTicketMicros;
        let storedPermitsToSpend = Math.min(requiredPermits, this._storedPermits);
        let freshPermits = requiredPermits - storedPermitsToSpend;

        let waitMicros = this.storedPermitsToWaitTime(this._storedPermits, storedPermitsToSpend) + (freshPermits * this._stableIntervalMicros);

        this._nextFreeTicketMicros = nextFreeTicketMicros + waitMicros;
        this._storedPermits -= storedPermitsToSpend;

        return returnValue;
    }

    /**
     * Translates a specified portion of our currently stored permits which we want to
     * spend/acquire, into a throttling time. Conceptually, this evaluates the integral
     * of the underlying function we use, for the range of
     * [(storedPermits - permitsToTake), storedPermits].
     *
     * &lt;p&gt;This always holds: {@code 0 &lt;= permitsToTake &lt;= storedPermits}
     */
    storedPermitsToWaitTime(storedPermits, permitsToTake) {
        Errors.throwNotImplemented();
    }

    /**
     *
     * @param {Number} nowMicros
     * @return {Number}
     */
    resync(nowMicros) {
        if (Utility.isNullOrUndefined(nowMicros)) {
            nowMicros = this.stopwatch.elapsedMicros();
        }

        // if nextFreeTicket is in the past, resync to now
        let nextFreeTicketMicros = this._nextFreeTicketMicros;

        if (nowMicros &gt; nextFreeTicketMicros) {
            this._storedPermits = Math.min(this._maxPermits, this._storedPermits + (nowMicros - nextFreeTicketMicros) / this._stableIntervalMicros);

            nextFreeTicketMicros = this._nextFreeTicketMicros = nowMicros;
        }

        return nextFreeTicketMicros;
    }
}

/**
 * This implements a &quot;bursty&quot; RateLimiter, where storedPermits are translated to
 * zero throttling. The maximum number of permits that can be saved (when the RateLimiter is
 * unused) is defined in terms of time, in this sense: if a RateLimiter is 2qps, and this
 * time is specified as 10 seconds, we can save up to 2 * 10 = 20 permits.
 */
class SmoothBurstyRateLimiter extends SmoothRateLimiter {

    /** The work (permits) of how many seconds can be saved up if this RateLimiter is unused? */
    maxBurstSeconds;

    /**
     * @param {Object} options
     * @param {Number} options.maxBurstSeconds
     * @param {Stopwatch} [options.stopwatch]
     */
    constructor(options) {
        let maxBurstSeconds = Utility.take(options, &apos;maxBurstSeconds&apos;, &apos;number&apos;, true);

        // SleepingStopwatch stopwatch, double maxBurstSeconds
        super(...arguments);

        this.maxBurstSeconds = maxBurstSeconds;
    }

    /**
     *
     * @param {Number} permitsPerSecond
     * @param {Number} stableIntervalMicros
     */
    doSetRate2(permitsPerSecond, stableIntervalMicros) {
        let oldMaxPermits = Utility.defaultNumber(this._maxPermits);
        let maxBurstSeconds = Utility.defaultNumber(this.maxBurstSeconds);

        this._maxPermits = maxBurstSeconds * permitsPerSecond;

        // if (oldMaxPermits == Double.POSITIVE_INFINITY) {
        //     // if we don&apos;t special-case this, we would get storedPermits == NaN, below
        //     this.storedPermits = maxPermits;
        // } else {
        this._storedPermits = (oldMaxPermits == 0.0)
            ? 0.0 // initial state
            : this._storedPermits * this._maxPermits / oldMaxPermits;
        // }

        Preconditions.shouldBeNumber(this._storedPermits, &apos;storedPermits&apos;);
        Preconditions.shouldBeNumber(this._maxPermits, &apos;_maxPermits&apos;);
    }

    /**
     *
     * @param {Number} storedPermits
     * @param {Number} permitsToTake
     * @return {number}
     */
    storedPermitsToWaitTime(storedPermits, permitsToTake) {
        return 0;
    }
}

class SmoothWarmingUpRateLimiter extends SmoothRateLimiter {

    warmupPeriodMicros;

    /**
     * The slope of the line from the stable interval (when permits == 0), to the cold interval
     * (when permits == maxPermits)
     */
    slope;
    halfPermits;

    constructor(options) {
        //    SleepingStopwatch stopwatch, long warmupPeriod, TimeUnit timeUnit
        let timeUnit = Utility.take(options, &apos;timeUnit&apos;, TimeUnit, true);
        let warmupPeriod = Utility.take(options, &apos;warmupPeriod&apos;, &apos;number&apos;, true);

        super(...arguments);

        this.warmupPeriodMicros = timeUnit.toMicros(warmupPeriod);
    }

    /**
     * @private
     * @param permitsPerSecond
     * @param stableIntervalMicros
     */
    doSetRate2(permitsPerSecond, stableIntervalMicros) {
        let oldMaxPermits = this._maxPermits;
        this._maxPermits = this.warmupPeriodMicros / stableIntervalMicros;
        this.halfPermits = this._maxPermits / 2.0;

        // Stable interval is x, cold is 3x, so on average it&apos;s 2x. Double the time -&gt; halve the rate
        let coldIntervalMicros = stableIntervalMicros * 3.0;
        this.slope = (coldIntervalMicros - stableIntervalMicros) / this.halfPermits;

        // if (oldMaxPermits == Number.POSITIVE_INFINITY) {
        //     // if we don&apos;t special-case this, we would get storedPermits == NaN, below
        //     this._storedPermits = 0.0;
        // } else {
            this._storedPermits = (oldMaxPermits == 0.0)
                ? this._maxPermits // initial state is cold
                : this._storedPermits * this._maxPermits / oldMaxPermits;
        // }
    }

    /**
     * @private
     * @param storedPermits
     * @param permitsToTake
     * @return {number}
     */
    storedPermitsToWaitTime(storedPermits, permitsToTake) {
        let availablePermitsAboveHalf = storedPermits - this.halfPermits;
        let micros = 0;
        // measuring the integral on the right part of the function (the climbing line)
        if (availablePermitsAboveHalf &gt; 0.0) {
            let permitsAboveHalfToTake = Math.min(availablePermitsAboveHalf, permitsToTake);
            micros = (permitsAboveHalfToTake * (this.permitsToTime(availablePermitsAboveHalf)
                + this.permitsToTime(availablePermitsAboveHalf - permitsAboveHalfToTake)) / 2.0);
            permitsToTake -= permitsAboveHalfToTake;
        }
        // measuring the integral on the left part of the function (the horizontal line)
        micros += (this._stableIntervalMicros * permitsToTake);
        return micros;
    }

    /**
     * @private
     * @param permits
     * @return {*}
     */
    permitsToTime(permits) {
        return this._stableIntervalMicros + permits * this.slope;
    }
}

export {RateLimiter};
export {SmoothRateLimiter};
export {SmoothBurstyRateLimiter};
export {SmoothWarmingUpRateLimiter};
export default SmoothRateLimiter;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.0-alpha)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
